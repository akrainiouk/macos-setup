#!/bin/bash

source "$(bash-include-path)/common.sh"
source "$(bash-include-path)/mvn-utils.sh"

(( $# == 1 )) || error "Usage: $(basename "$0") <repository-id>"
deployRepo="$1"

test -f pom.xml || error "pom.xml not found. Not a maven project"
echo "Verifying git repo..."
git status -s || error "aborting"
test -z "$(git status -s)" || error "Uncommitted changes, aborting"

timeStamp="$(date "+T%Y%m%d%H%M")"
artifactVersion=$(artifactVersion pom.xml)
lastCommit=$(git log --format="%h" -n 1)
releaseTag=$(echo "$artifactVersion" | sed -e "s/SNAPSHOT/$timeStamp-$lastCommit/g")

echo "Updating project version to: [$releaseTag]"
mvn version:set $releaseTag
echo "Rebuilding and deploying..."
mvn clean install source:jar deploy -DaltDeploymentRepository=test::file:///tmp/maven-test1
echo "Reverting project version to its original state"
mvn versions:revert
echo "All done"

